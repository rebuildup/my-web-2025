# 全機能統合テスト ドキュメント

## 概要

このドキュメントでは、ポートフォリオコンテンツデータ拡張システムの全機能統合テストについて説明します。統合テストは、システムの全ての拡張機能が正しく連携して動作することを確認するための包括的なテストスイートです。

## テスト構成

### テストファイル構成

```
tests/
├── integration/
│   ├── comprehensive-integration-test.js  # メインテストスイート
│   └── test-runner.js                     # テスト実行管理
├── package-scripts/
│   └── run-integration-tests.js           # テスト実行スクリプト
└── test-reports/                          # テスト結果レポート
    ├── integration-test-report.json
    └── integration-test-report.html
```

### テスト実行コマンド

```bash
# 統合テストの実行
npm run test:integration

# または直接実行
node package-scripts/run-integration-tests.js
```

## テストスイート詳細

### 1. データマネージャー統合テスト

**目的**: データマネージャーの基本機能と新機能の統合動作確認

**テスト内容**:

- データマネージャーへのアクセス
- 新規アイテム作成フォームの表示
- 基本情報（タイトル、説明、ステータス）の入力
- フォームバリデーション
- データ保存機能

**期待結果**:

- データマネージャーが正常に表示される
- 全ての入力フィールドが機能する
- バリデーションエラーが適切に表示される
- データが正常に保存される

### 2. 複数カテゴリー選択テスト

**目的**: 複数カテゴリー選択機能の動作確認

**テスト内容**:

- カテゴリータブの表示
- 複数カテゴリーの選択・選択解除
- Otherカテゴリーの特別な動作
- 選択状態の保持

**期待結果**:

- 複数のカテゴリーを同時選択できる
- 選択されたカテゴリーが正しく保存される
- Otherカテゴリーの制限が正しく動作する

### 3. タグ管理システムテスト

**目的**: 改善されたタグ管理機能の動作確認

**テスト内容**:

- 既存タグ一覧の表示
- 新しいタグの作成
- タグの選択・選択解除
- タグ検索機能
- タグの使用頻度更新

**期待結果**:

- 既存タグが正しく表示される
- 新しいタグが作成・保存される
- タグ検索が正常に動作する
- 使用頻度が正しく更新される

### 4. 日付管理システムテスト

**目的**: 手動日付設定機能の動作確認

**テスト内容**:

- 日付タブの表示
- 手動日付設定の有効化
- 日付ピッカーでの日付選択
- 日付フォーマットの確認
- 自動日付との切り替え

**期待結果**:

- 日付ピッカーが正常に動作する
- 設定した日付が正しく保存される
- 日付フォーマットが適切に表示される

### 5. ファイルアップロードシステムテスト

**目的**: 拡張されたファイルアップロード機能の動作確認

**テスト内容**:

- 標準処理でのファイルアップロード
- 変換なしオプションでのアップロード
- ファイル形式の検証
- アップロード進捗の表示
- エラーハンドリング

**期待結果**:

- 両方のアップロードオプションが動作する
- 不正なファイル形式が拒否される
- アップロード状況が正しく表示される
- エラーが適切に処理される

### 6. マークダウンエディターテスト

**目的**: マークダウンエディター機能の動作確認

**テスト内容**:

- マークダウンエディターの表示
- コンテンツの入力・編集
- リアルタイムプレビュー
- ファイル保存機能
- 構文ハイライト

**期待結果**:

- エディターが正常に表示される
- プレビューがリアルタイムで更新される
- マークダウンファイルが正しく保存される

### 7. ギャラリー表示テスト

**目的**: 各ギャラリーページでの表示確認

**テスト内容**:

- 全ギャラリー（All、develop、video、design、video&design）での表示
- カテゴリー別フィルタリング
- 複数カテゴリーアイテムの表示
- Otherカテゴリーの表示制御

**期待結果**:

- 各ギャラリーで適切なアイテムが表示される
- 複数カテゴリーアイテムが正しく表示される
- Otherカテゴリーの制限が正しく動作する

### 8. video&designページ特別テスト

**目的**: video&designページの修正された表示機能の確認

**テスト内容**:

- video、design、video&designカテゴリーの統合表示
- 重複除去機能
- フィルタリング機能
- パフォーマンス確認

**期待結果**:

- 3つのカテゴリーのアイテムが全て表示される
- 同じアイテムが重複して表示されない
- フィルタリングが正常に動作する

### 9. API統合テスト

**目的**: バックエンドAPIの統合動作確認

**テスト内容**:

- コンテンツ取得API
- タグ管理API
- ファイルアップロードAPI
- マークダウンファイルAPI
- データ整合性確認

**期待結果**:

- 全てのAPIが正常にレスポンスを返す
- データの整合性が保たれている
- エラーハンドリングが適切に動作する

### 10. パフォーマンステスト

**目的**: システム全体のパフォーマンス確認

**テスト内容**:

- ページロード時間の測定
- API応答時間の測定
- データベースクエリ性能
- ファイル操作性能
- メモリ使用量の確認

**期待結果**:

- ページロード時間が5秒以内
- API応答時間が2秒以内
- データベースクエリが3秒以内
- メモリ使用量が適切な範囲内

### 11. セキュリティテスト

**目的**: セキュリティ機能の動作確認

**テスト内容**:

- XSS攻撃の防御
- SQLインジェクション防御
- ファイルアップロードセキュリティ
- 入力値サニタイゼーション
- 認証・認可機能

**期待結果**:

- XSS攻撃が防がれる
- SQLインジェクションが防がれる
- 不正なファイルアップロードが拒否される
- 入力値が適切にサニタイズされる

### 12. データ整合性テスト

**目的**: データの整合性と一貫性の確認

**テスト内容**:

- データベースとファイルシステムの整合性
- 関連データの一貫性
- データ移行の正確性
- バックアップ・復旧の整合性

**期待結果**:

- データベースとファイルの整合性が保たれる
- 関連データが一貫している
- データ移行が正確に実行される

### 13. 既存機能互換性テスト

**目的**: 既存機能との互換性確認

**テスト内容**:

- 旧形式データの処理
- 既存APIの動作
- レガシー機能の保持
- データ移行の互換性

**期待結果**:

- 旧形式データが正しく処理される
- 既存APIが正常に動作する
- レガシー機能が保持される

## テスト実行環境

### 前提条件

- Node.js 16以上
- npm または yarn
- PostgreSQL データベース
- テスト用のポート3000が利用可能

### 環境変数

```bash
NODE_ENV=test
DATABASE_URL=postgresql://test_user:test_pass@localhost:5432/test_db
UPLOAD_DIR=./test-uploads
MARKDOWN_DIR=./test-markdown
```

### 必要なパッケージ

```json
{
  "devDependencies": {
    "@playwright/test": "^1.40.0",
    "playwright": "^1.40.0"
  }
}
```

## テスト結果レポート

### JSON レポート

テスト結果は `./test-reports/integration-test-report.json` に保存されます。

```json
{
  "startTime": "2024-02-01T10:00:00.000Z",
  "endTime": "2024-02-01T10:15:30.000Z",
  "totalTests": 15,
  "passedTests": 14,
  "failedTests": 1,
  "skippedTests": 0,
  "testDetails": [...],
  "systemInfo": {...},
  "performanceMetrics": {...}
}
```

### HTML レポート

視覚的なレポートは `./test-reports/integration-test-report.html` に生成されます。

**レポート内容**:

- テスト結果サマリー
- 成功率とパフォーマンスメトリクス
- 各テストの詳細結果
- エラー情報とスタックトレース
- システム情報

## トラブルシューティング

### よくある問題と解決方法

#### 1. サーバー起動エラー

**症状**: テストサーバーが起動しない

**原因と対処法**:

- ポート3000が使用中 → 他のプロセスを終了
- 依存関係の不足 → `npm install` を実行
- 環境変数の設定不備 → `.env.test` ファイルを確認

#### 2. データベース接続エラー

**症状**: データベースに接続できない

**原因と対処法**:

- PostgreSQLが起動していない → サービスを開始
- 接続情報が間違っている → `DATABASE_URL` を確認
- テスト用データベースが存在しない → データベースを作成

#### 3. ファイルアップロードエラー

**症状**: ファイルアップロードテストが失敗する

**原因と対処法**:

- アップロードディレクトリの権限不足 → 権限を修正
- ディスク容量不足 → 容量を確保
- ファイルサイズ制限 → 設定を確認

#### 4. タイムアウトエラー

**症状**: テストがタイムアウトで失敗する

**原因と対処法**:

- システムリソース不足 → リソースを確保
- ネットワーク遅延 → タイムアウト値を調整
- データベースの応答遅延 → インデックスを確認

#### 5. メモリ不足エラー

**症状**: テスト実行中にメモリ不足が発生

**原因と対処法**:

- 大量のテストデータ → テストデータを削減
- メモリリークの可能性 → コードを確認
- システムメモリ不足 → メモリを増設

### デバッグ方法

#### 1. 詳細ログの有効化

```bash
DEBUG=* npm run test:integration
```

#### 2. 特定のテストのみ実行

```bash
npx playwright test --grep "データマネージャー統合テスト"
```

#### 3. ヘッドフルモードでの実行

```bash
npx playwright test --headed
```

#### 4. スクリーンショット付きでの実行

```bash
npx playwright test --screenshot=on
```

## 継続的インテグレーション

### GitHub Actions 設定例

```yaml
name: Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  integration-tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:13
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install

      - name: Run integration tests
        run: npm run test:integration
        env:
          DATABASE_URL: postgresql://postgres:test_password@localhost:5432/test_db

      - name: Upload test reports
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-reports
          path: test-reports/
```

## メンテナンス

### テストの更新

新機能を追加した場合は、対応する統合テストも追加してください：

1. `comprehensive-integration-test.js` に新しいテストケースを追加
2. 必要に応じて `test-runner.js` を更新
3. テストデータを `TEST_DATA` に追加
4. ドキュメントを更新

### パフォーマンス基準の見直し

システムの成長に合わせて、パフォーマンス基準を定期的に見直してください：

- ページロード時間の閾値
- API応答時間の閾値
- メモリ使用量の上限
- データベースクエリ時間の上限

### テスト環境の保守

- テストデータベースの定期的なクリーンアップ
- テストファイルの整理
- 依存関係の更新
- セキュリティパッチの適用

---

この統合テストスイートにより、ポートフォリオシステムの全機能が正しく連携して動作することを確認できます。定期的にテストを実行し、システムの品質を維持してください。
